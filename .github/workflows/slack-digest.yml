name: Daily Changelog Digest to Slack

on:
  schedule:
    - cron: '30 13 * * *'  # 7:00 PM IST daily (13:30 UTC)
  workflow_dispatch:

jobs:
  send-digest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Get today's date
        id: date
        run: |
          echo "today=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT
          echo "display_date=$(date '+%B %d, %Y')" >> $GITHUB_OUTPUT
      
      - name: Extract today's changelog
        id: extract
        run: |
          TODAY="${{ steps.date.outputs.today }}"
          
          if [ ! -f CHANGELOG.md ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No CHANGELOG.md file found"
            exit 0
          fi
          
          # Extract today's entries
          awk -v date="## $TODAY" '
            $0 ~ date { found=1; next }
            found && /^## [0-9]{4}-[0-9]{2}-[0-9]{2}/ { exit }
            found { print }
          ' CHANGELOG.md > today_changes.txt
          
          if [ ! -s today_changes.txt ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          # Format for Slack
          cat today_changes.txt | \
            sed 's/^### \(.*\)/*\1*/g' | \
            sed -E 's| \(#([0-9]+)\)| <https://github.com/${{ github.repository }}/pull/\1\|#\1>|g' \
            > formatted_changes.txt
 
      - name: Create Slack payload
        if: steps.extract.outputs.has_changes == 'true'
        run: |
          # Properly escape changes for JSON
          CHANGES=$(cat formatted_changes.txt | jq -Rs .)
          
          # Create payload file
          cat > slack-payload.json << EOF
          {
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "Changelog Update - ${{ steps.date.outputs.display_date }}",
                  "emoji": true
                }
              },
              {
                "type": "divider"
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": $CHANGES
                }
              },
              {
                "type": "divider"
              },
              {
                "type": "context",
                "elements": [
                  {
                    "type": "mrkdwn",
                    "text": "View full changelog: <https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md|CHANGELOG.md>"
                  }
                ]
              }
            ]
          }
          EOF
      
      - name: Send to Slack
        if: steps.extract.outputs.has_changes == 'true'
        uses: slackapi/slack-github-action@v1.26.0
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload-file-path: "./slack-payload.json"
